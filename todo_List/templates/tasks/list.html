{% extends "base.html" %}
{% block title %}My Tasks{% endblock %}

{% block content %}
<script>
    if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }
    window.onpageshow = function(event) {
        if (event.persisted) {
            window.location.href = "{% url 'welcome' %}";
        }
    };
</script>

<div class="tasks-header">
    <h2>Hello, {{ user.username }}</h2>
    <a href="{% url 'task_create' %}" class="add-task-btn">+ Add Task</a>
</div>

<div class="tasks-grid">
    {% for task in tasks %}
        <div class="task-card {% if task.complete %}done{% endif %}">
            <div class="task-header">
                <input type="checkbox" class="task-checkbox" data-task-id="{{ task.pk }}" {% if task.complete %}checked{% endif %}>
                <h3>{{ task.title }}</h3>
            </div>
            <p class="task-desc">{{ task.description }}</p>
            <div class="task-actions">
                <a href="{% url 'task_update' task.pk %}" class="edit-btn">Edit</a>
                <form action="{% url 'task_delete' task.pk %}" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this task?');">
                    {% csrf_token %}
                    <button type="submit" class="delete-btn">Delete</button>
                </form>
            </div>
        </div>
    {% empty %}
        <p>No tasks yet.</p>
    {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const checkboxes = document.querySelectorAll(".task-checkbox");

    checkboxes.forEach(cb => {
        cb.addEventListener("change", (e) => {
            const taskId = e.target.dataset.taskId;
            const checked = e.target.checked;

            document.querySelectorAll(`.task-checkbox[data-task-id='${taskId}']`).forEach(other => {
                if (other !== e.target) other.checked = checked;
            });

            fetch("{% url 'toggle_task_complete' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: `task_id=${taskId}`
            }).then(res => res.json()).then(data => {
                if(!data.success){
                    alert("Failed to update task.");
                    e.target.checked = !checked; 
                }
            });
        });
    });
});
</script>


{% endblock %}
